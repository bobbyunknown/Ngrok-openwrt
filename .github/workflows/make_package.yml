# This is open source software, licensed under the MIT License.
# https://opensource.org/license/mit
# 
# Copyright (C) 2024 BobbyUnknown
#
# Description:
# This software provides a secure tunneling application for OpenWrt.
# The application allows users to configure and manage ngrok tunnels
# on their OpenWrt router, enabling secure remote access to local
# network services through public endpoints. It features a user-friendly
# web interface for easy tunnel management and configuration.

name: Build Ngrok Package

on:
  workflow_dispatch:
    inputs:
      luci-app-ngrok_version:
        description: 'LuCI App Ngrok version'
        required: true
        default: '1.0.0'
        type: string

jobs: 
  build_ipk:
    permissions:
      contents: write
    name: Build ngrok
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: main

      - name: Set up Docker
        run: |
          docker pull openwrt/sdk:x86-legacy
          mkdir -p bin

      - name: Build Package
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/home/build/openwrt/package/feeds \
            -v ${{ github.workspace }}/bin:/home/build/openwrt/bin \
            openwrt/sdk:x86-legacy \
            /bin/bash -c '
              cd /home/build/openwrt
              ./scripts/feeds update -a
              ./scripts/feeds install -a
              make defconfig
              make package/feeds/luci-app-ngrok/compile V=s
            '

      - name: Upload Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: ${{ github.workspace }}/bin/packages/x86_64/base/*
          file_glob: true
          overwrite: true
          tag: ${{ inputs.luci-app-ngrok_version }}
          body: |
            # üåê Ngrok for OpenWrt
            
            ## üì¶ Release Information
            - LuCI App Version: ${{ inputs.luci-app-ngrok_version }}
            
            ### üìù Description
            This software provides a secure remote access and reverse proxy application for OpenWrt.
            
            ### üì¶ Packages:
            - ngrok-core: Tunnel service binary
            - luci-app-ngrok: Web interface for configuration
            
            ### üìã Requirements:
            - OpenWrt 23+
            - Architecture: x86_64

