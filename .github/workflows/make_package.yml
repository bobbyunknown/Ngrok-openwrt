# This is open source software, licensed under the MIT License.
# https://opensource.org/license/mit
# 
# Copyright (C) 2024 BobbyUnknown
#
# Description:
# This software provides a secure tunneling application for OpenWrt.
# The application allows users to configure and manage ngrok tunnels
# on their OpenWrt router, enabling secure remote access to local
# network services through public endpoints. It features a user-friendly
# web interface for easy tunnel management and configuration.

name: Build Ngrok Package & Core

on:
  workflow_dispatch:
    inputs:
      ngrok_version:
        description: 'Ngrok version'
        required: true
        default: 'v3.19.1'
        type: string
      luci-app-ngrok_version:
        description: 'LuCI App Ngrok version'
        required: true
        default: '1.0.0'
        type: string

jobs:
  build_packages:
    name: Build Packages
    runs-on: ubuntu-latest
    container:
      image: openwrt/sdk:aarch64_generic-openwrt-24.10
    steps:
      - uses: actions/checkout@v4
      
      - name: Prepare Build
        run: |
          mkdir -p feeds/ngrok feeds/luci
          cp -rf ./ngrok-arm/* ./feeds/ngrok/
          cp -rf ./luci-app-ngrok/* ./feeds/luci/
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
      - name: Configure Build
        run: |
          echo "CONFIG_PACKAGE_ngrok=y" > .config
          echo "CONFIG_PACKAGE_luci-app-ngrok=y" >> .config
          make defconfig
          
      - name: Build Packages
        env:
          NGROK_VERSION: ${{ inputs.ngrok_version }}
          LUCI_APP_VERSION: ${{ inputs.luci-app-ngrok_version }}
        run: |
          make package/ngrok/compile -j$(nproc)
          make package/luci-app-ngrok/compile -j$(nproc)
          
      - name: Upload Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: bin/packages/aarch64_generic/action/*
          file_glob: true
          overwrite: true
          tag: ${{ inputs.luci-app-ngrok_version }}
          body: |
            # ğŸŒ Ngrok for OpenWrt
            
            ## ğŸ“¦ Release Information
            - Core Version: ${{ inputs.ngrok_version }}
            - LuCI App Version: ${{ inputs.luci-app-ngrok_version }}
            
            ### ğŸ“ Description
            This software provides a secure remote access and reverse proxy application for OpenWrt.
            
            ### ğŸ“¦ Packages:
            - ngrok-core: Tunnel service binary
            - luci-app-ngrok: Web interface for configuration
            
            ### ğŸ“‹ Requirements:
            - OpenWrt 23+
            - Architecture: aarch64

